fastlane_version "2.28.3"

default_platform :android

platform :android do
  desc "Set appicons"
  lane :icon do
    android_appicon(
      appicon_image_file: '../assets/sentrei.png',
      appicon_icon_types: [:launcher],
      appicon_path: 'app/src/main/res/mipmap',
      appicon_filename: 'ic_launcher',
    )
  end

  desc "Submit a new beta build to firebase"
  lane :beta do
    analyze_commits(
      match: "v*-beta*"
    )
    build = ENV['GITHUB_RUN_NUMBER']
    version = lane_context[SharedValues::RELEASE_NEXT_VERSION]
    add_badge(
      dark: true,
      shield: "#{version}-#{build}-blue",
      no_badge: true,
      glob: "/app/src/main/res/mipmap-*/ic_launcher*.png",
    )
    sh("cd ../.. && flutter build apk --flavor beta")
    notes = conventional_changelog(
      format: "plain",
      title: "sentrei master",
    )
    firebase_app_distribution(
      groups: "beta",
      app: "1:258612152633:android:0344f8ed2ff95c50ff40e8",
      firebase_cli_token: ENV['FIREBASE_TOKEN'],
      release_notes: notes,
      apk_path: "../build/app/outputs/apk/beta/release/app-beta-release.apk"
    )
  end

  desc "Submit a new master build to firebase"
  lane :master do
    analyze_commits(
      match: "v*"
    )
    sh("cd ../.. && flutter build apk --flavor master")
    notes = conventional_changelog(
      format: "plain",
      title: "sentrei master",
    )
    firebase_app_distribution(
      groups: "master",
      app: "1:721847679884:android:1935b57831163cda5bb4a9",
      firebase_cli_token: ENV['FIREBASE_TOKEN'],
      release_notes: notes,
      apk_path: "../build/app/outputs/apk/master/release/app-master-release.apk"
    )
  end
end
